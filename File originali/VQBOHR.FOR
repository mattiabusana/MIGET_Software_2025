C     THIS PROGRAM COMBINES VQDIST WITH BOHR INTEGRATION (KELMAN CURVES)
C     BASICALLY FOLLOWS HEMPLEMAN AND GRAY, JUNE 88
C
C     THIS VERSION FINDS DLO2 ITERATIVELY BY QUADRATIC INTERPOLATION
C     USING THREE STARTING GUESSES AT DLO2 ("DM") TO CALCULATE THE THREE
C     COEFFICIENTS (A,B,C) OF:  PO2ERR = A.DM.DM + B.DM + C
C     PO2ERR IS THE DIFFERENCE BETWEEN MEASURED AND PREDICTED ARTERIAL PO2
C     THESE GUESSES ARE 0.010, 0.015 AND 0.020 OF THE MEASURED VO2
C     DLO2 IN ML/MIN/TORR AND VO2 IN ML/MIN. HOWEVER, TO ENSURE 
C     NUMERICAL STABILITY, THE FIRST VALUE (0.010) IS STEPPED DOWN IF
C     ITS PO2ERR IS POSITIVE, UNTIL PO2ERR JUST BECOMES NEGATIVE, WITH DM
C     BEING 0.8 OF ITS PREVIOUS VALUE EACH STEP. SIMILARLY, THE THIRD
C     VALUE (0.020) IS STEPPED UP TO 1.2 OF ITS PREVIOUS VALUE IF ITS
C     PO2ERR IS NEGATIVE, UNTIL PO2ERR JUST BECOMES POSITIVE. 
C     FOR EACH OF THESE GUESSES, THE ACTUAL PO2ERR IS COMPUTED BY RUNNING 
C     THE BOHR INTEGRATION, TO GIVE 3 EQNS IN 3 UNKNOWNS (A,B,C):
C
C           PO2ERR(1) = A.DM(1).DM(1)  +  B.DM(1)  +  C
C           PO2ERR(2) = A.DM(2).DM(2)  +  B.DM(2)  +  C
C           PO2ERR(3) = A.DM(3).DM(3)  +  B.DM(3)  +  C 
C
C     NEXT, THE VALUE OF DM THAT GIVES PO2ERR=0 IS CALCULATED FROM
C     THIS QUADRATIC, AND ITS ACTUAL PO2ERR COMPUTED BY RUNNING THE
C     BOHR INTEGRATION WITH THIS NEW VALUE OF DM.
C
C     THE FIRST (DM,PO2ERR) PAIR IS NOW DROPPED, THE MOST RECENT PAIR
C     RETAINED, FORMING AN UPDATED SET OF THREE (DM,PO2ERR) PAIRS, AND
C     A NEW SET OF QUADRATIC COEFFICIENTS IS COMPUTED FROM THEM.
C
C     THIS PROCESS IS REPEATED TO CONVERGENCE TO WITHIN THE DESIRED
C     TOLERANCE, CURRENTLY STATED AS PO2ERR < 0.1 TORR ABSOLUTE.
C
      PROGRAM MAIN
      USE strings
      CHARACTER NAME(60),IO2,ISKO2
      DIMENSION IFLAG(24),X(4),Y(4)
      DIMENSION VSAVE(20,500),QSAVE(20,500)
      COMMON/VQ/V(500),Q(500),QQ(500),VAQ(500)
      COMMON/INERT/NVAQS,VT,QT,NGASES,FACT,Z,VQLO,VQHI
      COMMON/OXY1/HB,HCRIT,TEMP,APH,BPH,APCO2,BPCO2,KOUNT,DP50,PIO2,SO2
      COMMON/OXY2/PB,FIO2,PICO2,FICO2,VS,QS,SKEW,GVO2,GVCO2,TOL,
     +PVO2,PVCO2,FMVO2,FMVCO2,PVN2,ALPHA,SHUNT,QR,GVAQ,FVQ,PAO2,
     +PACO2,O2CON,CCO2,PO2,PCO2,FVO2,FVCO2,RZ,RM,ARTO2C,ARTCO2,AMO2C
      COMMON/BOHR/DM,VC,BETA,RNT,DDLO2,DDLCO2,PMAO2,PMACO2,PO2B,PCO2B,
     +IBOHR,CAIII,IPRN,ARTPM,IWARN,IWARN2
      COMMON/O2ARAY/OO2CON(500),OCCO2(500),FVQQ(500),PN22(500),
     +PCO22(500),PO22(500),RZZ(500),PBO2(500),PBCO2(500)
     
      character paramInFile*1
      character paramFile*200
      character FILE8*90
      character FILE3*90
      character FILE9*90
      character FILE6*90
      character file3arg*90
      character file9arg*90
      character file6arg*90
      character toskip*90
      character args*20
      
C     FOR READING PARAMETER FILES
      integer len,status,val
      character c*90
      
c      ************* Parameters File ******************
      call get_command_argument (1, c, len, status)
      READ (c,*) IRORE 
      call get_command_argument (2, c, len, status)
      READ (c,*) IO2 
      call get_command_argument (3, c, len, status)
      READ (c,*) ISKO2
      call get_command_argument (4, c, len, status)
      READ (c,*) NT 
      call get_command_argument (5, c, len, status)
      READ (c,'(A)') paramFile
      call get_command_argument (6, c, len, status)
      READ (c,'(A)') file3arg 
      call get_command_argument (7, c, len, status)
      READ (c,'(A)') file9arg 
      call get_command_argument (8, c, len, status)
      READ (c,'(A)') file6arg
      call get_command_argument (9, c, len, status)
      READ (c,'(A)') SKIP   
C     ********** IFLAG PARAMETER **********************
      DO 10, I=1,24
 10   IFLAG(I)=0
      if(SKIP.eq.'1') then
      call get_command_argument (10, c, len, status)
      READ (c,'(A)') toskip 
      do
        call split(toskip,';',args)
        READ (args,*) val
        if(len_trim(toskip) == 0) then
            READ (args,*) IFLAG(val)
            exit
        else 
            READ (args,*) IFLAG(val)
        end if  
      end do
      end if
      
      FILE8=paramFile
      FILE3=''//file3arg
      FILE9=''//file9arg
      FILE6=''//file6arg
      
      
      IPRN=0
c      WRITE(*,310)
      OPEN (8,FILE=FILE8)
c      WRITE(*,320)
c      READ(*,*)IDP
      IDP=0
C      IF(IDP.LE.0) WRITE(*,330)
      IF(IDP.LE.0) OPEN(3,FILE=FILE3,STATUS='REPLACE')
      IF(IDP.GE.1) OPEN(3,FILE='PRN')
C      WRITE(*,390)
C      READ(*,*)IPLTVQ
      IPLTVQ=1
C      WRITE(*,395)
C      READ(*,*)IPLTRE
      IPLTRE=1
      IF(IPLTVQ.EQ.1) OPEN(9,FILE=FILE9,STATUS='REPLACE')
      IF(IPLTRE.EQ.1) OPEN(6,FILE=FILE6,STATUS='REPLACE')
      IF(IPLTVQ.EQ.1) WRITE(*,410)
      IF(IPLTRE.EQ.1) WRITE(*,415) 
      READ(8,20)(NAME(I),I=1,60)
 20   FORMAT(60A1)
      READ(8,30) NRUNS,PBSEA
 30   FORMAT(I4,F7.1)
C 40   WRITE(*,50)
 50   FORMAT(' ARE THESE SETS RETENTION OR EXCRETION WEIGHTED ?'/
     + '  (0 FOR R (USUAL WAY) OR 1 FOR E)')
C      READ(*,*)IRORE
C      IF(IRORE.NE.0 .AND. IRORE.NE.1) GO TO 40
C      WRITE(*,60)
 60   FORMAT('  ENTER SET NUMBERS TO BE SKIPPED, 20I3 FORMAT'/)
C      READ(*,65)(IFLAG(I),I=1,NRUNS)
  65  FORMAT(20I3)
C      WRITE(*,70)
 70   FORMAT(' DO YOU WANT O2/CO2 CALCS, D/Q INFINITE (Y/N) ?')
C      READ(*,90)IO2
      IF(IO2.NE.'Y') GO TO 110
C      WRITE(*,80)
 80   FORMAT(' DO YOU WANT BOHR INTEGRATION CALCULATIONS ? (Y/N)')
C      READ(*,90)ISKO2
 90   FORMAT(A1)
      IF(ISKO2.NE.'Y') GOTO 110
C      WRITE(*,100)
100   FORMAT(' ENTER # OF INTEGRATION STEPS (20 - 100), FREE FORMAT',/,
     1' AND FLAG SCREEN-PRINT OPTION (1=YES, 0=NO)')
C      READ(*,*)NT,IPRN
      IPRN=1
      RNT=NT
110   CONTINUE
      DO 300 KK=1,NRUNS
      ISKIP=0
      DO 120 KIJ=1,NRUNS
120   IF(IFLAG(KIJ).EQ.KK) ISKIP=1
      IF(ISKIP.EQ.0) WRITE(3,130)KK,(NAME(I),I=1,60)
      IF(ISKIP.EQ.0) WRITE(*,130)KK,(NAME(I),I=1,60)
130   FORMAT(/////,' SET NUMBER :'I3'  FROM FILE: '60A1)
      IF(ISKIP.EQ.0 .AND. IRORE.EQ.0) WRITE(3,140)
      IF(ISKIP.EQ.0 .AND. IRORE.NE.0) WRITE(3,150)
140   FORMAT(' FITTING A BLOOD FLOW DISTRIBUTION TO RETENTIONS'/)
150   FORMAT(' FITTING A VENTILATION DISTRIBUTION TO EXCRETIONS'/)
      READ(8,160) GVO2,GVCO2,PIO2,PB,TEMP,HB,HCRIT,PICO2,BX,DP50
160   FORMAT(F7.1,F8.1,F8.2,F7.1,3F6.1,F7.2,2F6.2)
      READ(8,170) X(1),Y(1),X(2),Y(2),X(3),Y(3),PVN2,SO2
170   FORMAT(7F7.1,F9.5)
      ALPHA=0.0017
      READ(8,180) PHA,PHV,APCO2,BPCO2,PMAO2,PMACO2
180   FORMAT(2F9.2,2F6.1,2F7.1)
      READ(8,190) NGASES,NVAQS,Z,VQLO,VQHI,VT,PH2O,QT,TOL
190   FORMAT(I3,I4,F6.1,F7.3,F7.1,2F8.2,F6.2,F8.0)
      IF(IO2.EQ.'N') GO TO 200
      Y1=0.003*HB*(100.0-SATURA(PMAO2,PMACO2,PHA))/100.0
      PHX=7.59+Y1-0.2741*ALOG(PMACO2/20.0)
      DELPH=PHA-PHX
      APH=7.59+DELPH-0.2741*ALOG(APCO2/20.0)
      BPH=7.59+DELPH-0.2741*ALOG(BPCO2/20.0)
      IF(PHV.LE.6.0.OR.PHV.GE.8.0) GO TO 200
      Y1=0.003*HB*(100.0-SATURA(X(1),Y(1),PHV))/100.0
      PHX=7.59+Y1-0.2741*ALOG(Y(1)/20.0)
      DELPH=PHV-PHX
      APHV=7.59+DELPH-0.2741*ALOG(APCO2/20.0)
      BPHV=7.59+DELPH-0.2741*ALOG(BPCO2/20.0)
      HA1=EXP(-APH)
      HA2=EXP(-APHV)
      HB1=EXP(-BPH)
      HB2=EXP(-BPHV)
      HA=(HA1+HA2)/2.0
      HBAV=(HB1+HB2)/2.0
      APH=-ALOG(HA)
      BPH=-ALOG(HBAV)
200   CONTINUE
      FACT = (PBSEA-PH2O)/100.0
      P50=26.8+DP50
      DSPCE=0.0
      KRUN=KK
      CALL CALCVQ(IPLTRE,ISKIP,DSPCE,SUMQ,KRUN,IRORE)
      IF(SUMQ.EQ.0.0) ISKIP=1
      IF(ISKIP.EQ.1) GO TO 300
      IF(IO2.EQ.'N') GO TO 300
      KOUNT=0
      WRITE(3,210)
210   FORMAT(30X,'GAS EXCHANGE')
      FIO2=PIO2/(PB-PH2O)
      FICO2=PICO2/(PB-PH2O)
      WRITE(3,220)GVO2,GVCO2,PIO2,FIO2,PICO2,FICO2,PB,TEMP,HB,HCRIT,
     + P50,BX
220   FORMAT(/'   GVO2',4X,'GVCO2',3X,'PIO2',3X,'FIO2',2X,'PICO2',
     +2X,'FICO2'2X'PB'4X'TEMP'3X'HB'2X'HCRIT'2X'P50'2X'BX'/,
     +2F8.1,1X,F6.1,F7.4,F5.1,2X,F6.2,1X,F6.1,3(1X,F5.1),2F5.1,/)
      CALL BLOOD(PMAO2,PMACO2,AMO2C,AMCO2C)
      WRITE(3,230)APH,APCO2,PMAO2,AMO2C,BPH,BPCO2,PMACO2,AMCO2C
230   FORMAT(4X,'FIRST  BLOOD PH =',F4.2,4X,'PCO2 =',F5.2,6X,
     +'PMAO2 =',F6.2,5X,'CMAO2 =',F6.2/,4X,'SECOND BLOOD PH =',F4.2,
     +4X,'PCO2 =',F5.2,6X,'PMACO2=',F6.2,5X,'CMACO2=',F6.2/)
      WRITE(3,240)VT,QT,SO2
240   FORMAT(/,25X,'TOTAL VENTILATION=',F12.2,/,
     + 25X,'TOTAL BLOOD FLOW =',F12.2,/,
     + 25X,'O2 SOLUBILITY    =',F12.4)
      WRITE(3,250)TOL
250   FORMAT(/,25X,'TOLERANCE        =',F12.2/)
      QR=QT
      IF(X(1).NE.GVO2 .OR. Y(1).NE.GVCO2) GO TO 280
      CALL BLOOD(PMAO2,PMACO2,AMO2C,AMCO2C)
      FMVO2=-GVO2/(10.0*QT)+AMO2C
      FMVCO2=GVCO2/(10.0*QT)+AMCO2C
      IF(FMVO2.GT.0.0) GO TO 270
      WRITE(3,260) FMVO2,FMVCO2
      WRITE(*,260)FMVO2,FMVCO2
260   FORMAT(' FICK CALC MIXED VENOUS O2 CONTENT='F5.1,5X,'CO2
     + CONTENT='F5.1,6X,'THEREFORE O2 CALCS IMPOSSIBLE'////////)
      GO TO 300
270   CALL FNDTEN(PVO2,PVCO2,FMVO2,FMVCO2)
      X(1)=PVO2
      Y(1)=PVCO2
280   CONTINUE
      DO 290 IBOHR=1,2
      CALL FNDMVP(KRUN,X,Y)
      CALL WRITE
      IF(IBOHR.EQ.2) GO TO 286
      DO 285 J=1,NVAQS
      VSAVE(KK,J)=V(J)
285   QSAVE(KK,J)=Q(J)
286   IF(ISKO2.EQ.'N') GO TO 300
290   CONTINUE
300   CONTINUE
310   FORMAT(' ENTER FILE NAME.EXT FOR VQ INPUT DATA',/)
320   FORMAT(' WRITE OUTPUT TO DISK (0) OR PRINTER (1) ?') 
330   FORMAT(' ENTER FILE NAME.EXT OF YOUR CHOICE FOR RESULTS')
C
C     WRITE DISTRIBUTION TO DISK FOR PLOTTING
C
      IF(IPLTVQ.EQ.0) GO TO 400
      ZERO=0.0
      VAQ(1)=0.001
      VAQ(NVAQS)=1000.
      DO 370 KK=1,NRUNS
      DO 340 KIJ=1,NRUNS
340   IF(IFLAG(KIJ).EQ.KK) GO TO 370
      IF(IPLTVQ.EQ.1.AND.KK.EQ.1) WRITE(3,355)
      IF(IPLTRE.EQ.1.AND.KK.EQ.1) WRITE(3,350)
350   FORMAT(' R & E PLOT VARIABLES FIELD IS 8 COLS, EACH 10 CHARS')
355   FORMAT('   V/Q PLOT VARIABLES FIELD IS 5 COLS, EACH 10 CHARS') 
      WRITE(9,380)VAQ(1),ZERO,ZERO,QSAVE(KK,1),ZERO
      DO 360 J=2,NVAQS-1
360   WRITE(9,380)VAQ(J),VSAVE(KK,J),QSAVE(KK,J),ZERO,ZERO
      WRITE(9,380)VAQ(NVAQS),ZERO,ZERO,ZERO,VSAVE(KK,NVAQS)
370   CONTINUE 
380   FORMAT(5F10.3)
390   FORMAT(' WANT TO HARDCOPY PLOT THE V/Q CURVES?  0=NO, 1=YES')
395   FORMAT(' WANT TO HARDCOPY PLOT THE R & E CURVES?  0=NO, 1=YES')
400   CONTINUE
410   FORMAT(' DATA FOR HARDCOPY VA/Q  PLOTS ARE IN:      C:VQPLOT.FYL')
415   FORMAT(' DATA FOR HARDCOPY R & E PLOTS ARE IN:      C:REPLOT.FYL')
      STOP
      END
      SUBROUTINE CALCVQ(IPLTRE,ISKIP,DSPCE,SUMQ,KRUN,IRORE)
      DIMENSION S(10),PC(10),RDATA(10),EDATA(10),AD(10)
      DIMENSION WEIGHT(10),RAWDAT(10),RAD(10)
      DIMENSION SOL(50),CALCDR(50),CALCDE(50),RHOMO(50),EHOMO(50)
      DIMENSION DKK(10,10),DQ(11),DV(11)
      CHARACTER IPLCHR
      COMMON/VQ/V(500),Q(500),QQ(500),VAQ(500)
      COMMON/INERT/NVAQS,VT,QT,NGASES,FACT,Z,VQLO,VQHI
      NGAS1=NGASES+1
      READ(8,10) (PC(I),I=1,NGASES)
10    FORMAT(1X,6(1PE12.3))
      PC(NGAS1)=0.0
      READ(8,20) (RDATA(I),I=1,NGASES)
      READ(8,20) (EDATA(I),I=1,NGASES)
20    FORMAT(8F12.6)
      READ(8,30) (WEIGHT(I),I=1,NGASES)
30    FORMAT(8(F11.2,1X))
      IF(ISKIP.EQ.1) RETURN
      DO 40, I=1,NGAS1
40    S(I)=PC(I)/FACT
      DO 50 I=1,NGASES
      IF(IRORE.EQ.0) RAWDAT(I)=RDATA(I)
50    IF(IRORE.NE.0) RAWDAT(I)=EDATA(I)
      RAWDAT(NGAS1)=1.0
      RAWDAT(NGAS1+1)=1.0
      WRITE(3,60)NGASES,NVAQS,Z
60    FORMAT(' NUMBER OF GASES ='I3/' NUMBER OF VA/Q COMPARTMENTS ='
     & I4,/,' SMOOTHING COEFFICIENT Z =',F8.2/)
      WRITE(3,70)
70    FORMAT(8X,'GAS'10X'SOL'12X'PC'14X'R'14X'E')
      DO 80, I=1,NGASES
80    WRITE(3,90)I,S(I),PC(I),RDATA(I),EDATA(I)
90    FORMAT(I10,4F15.5)
      NV=NVAQS-1
      RNV=NV
      DVQ=(ALOG(VQHI/VQLO))/RNV
      DO 110, J=1,NVAQS
      TJ=J
110   VAQ(J) = VQLO*EXP(DVQ*(TJ-1.0))
      VAQ(1)=0.0
      VAQ(NVAQS) = 10000.0
      IC=1
120   IF(IRORE.EQ.0) CALL SMOOTH(E,PC,RDATA,RAWDAT,WEIGHT,AD,IC,
     + SUMQ,IRORE)
      IF(IRORE.NE.0) CALL SMOOTH(E,PC,EDATA,RAWDAT,WEIGHT,AD,IC,
     + SUMV,IRORE)
      IF(IRORE.NE.0) GO TO 184
      VTNEW=0.0
      V(1)=0.0
      DO 140, J=1,NV
      QQ(J)=QQ(J)/SUMQ
      V(J) = QT*VAQ(J)*QQ(J)
140   VTNEW=VTNEW+ V(J)
      V(NVAQS)=VT-VTNEW
      DO 150, J=1,NVAQS
150   V(J)=V(J)/VT
C      WRITE(3,155)
C155   FORMAT(4X,'I'7X,'PC',8X,'AD/WEIGHT',8X,'RAD')
      DO 170, I=1,NGASES
      RAD(I)=0.0
      DO 160, J=1,NV
160   RAD(I)=RAD(I)+QQ(J)*PC(I)/(VAQ(J)+PC(I))
C      WRITE(3,180)I,PC(I),AD(I)/WEIGHT(I),RAD(I)
170   CONTINUE
C180   FORMAT(I5,F11.4,2F15.8)
C      WRITE(3,182) IC,QT,VT,VTNEW,VTNEW/VT
C182   FORMAT(I5,3X,'QT:'F6.3,3X,'VT:'F7.3,3X,'CALC:'F9.5,3X,
C     & 'CALC/MEAS:'F8.5)
      QQ(NVAQS)=0.0
      GO TO 198
184   QTNEW=0.0
      QQ(NVAQS)=0.0
      V(1)=0.0
      DO 186, J=2,NV
      V(J)=V(J)/SUMV
      QQ(J) = V(J)*VT/VAQ(J)
186   QTNEW=QTNEW+ QQ(J)
      V(NVAQS)=V(NVAQS)/SUMV
      QQ(1)=QT-QTNEW
      DO 188, J=1,NVAQS
188   QQ(J)=QQ(J)/QT
C      WRITE(3,189)
C189      FORMAT(4X'I'7X'PC'8X'AD/WEIGHT'8X'EXC'11X'RETEN'11X'RAD')
      DO 192, I=1,NGASES
      RAD(I)=0.0
      EXC=0.0
      DO 190, J=1,NV
      EXC=EXC+ V(J)*PC(I)/(VAQ(J)+PC(I))
190   RAD(I)=RAD(I)+QQ(J)*PC(I)/(VAQ(J)+PC(I))
      RETEN=1.0- VT*EXC/(PC(I)*QT)
C      WRITE(3,194) I,PC(I),AD(I)/WEIGHT(I),EXC,RETEN,RAD(I)
192   CONTINUE
C194   FORMAT(I5,F11.4,4F15.8)
C      WRITE(3,182) IC,QT,VT,QTNEW,QTNEW/QT
198   SHNT=QQ(1)
      DSPCE=V(NVAQS)
      SMQPO1=0.0
      SMVPO1=0.0
      SMQP1=0.0
      SMVP1=0.0
      SMQ1=0.0
      SMV1=0.0
      SMQ10=0.0
      SMV10=0.0
      SMQ100=0.0
      SMV100=0.0
      DO 240, J=2,NV
      IF(VAQ(J).GT.0.01) GO TO 200
      SMQPO1=SMQPO1 + QQ(J)
      SMVPO1=SMVPO1 + V(J)
      GO TO 240
200   IF(VAQ(J).GT.0.1) GO TO 210
      SMQP1=SMQP1 + QQ(J)
      SMVP1=SMVP1 + V(J)
      GO TO 240
210   IF(VAQ(J).GT.1.0) GO TO 220
      SMQ1=SMQ1 + QQ(J)
      SMV1 =SMV1 + V(J)
      GO TO 240
220   IF(VAQ(J).GT.10.0) GO TO 230
      SMQ10=SMQ10 + QQ(J)
      SMV10=SMV10 + V(J)
      GO TO 240
230   SMQ100=SMQ100 + QQ(J)
      SMV100=SMV100 + V(J)
240   CONTINUE
      WRITE(3,250)
250   FORMAT(//6X'RANGE'17X'BLOOD FLOW'11X'VENTILATION'/)
      WRITE(3,260)SHNT
      WRITE(3,270)SMQPO1,SMVPO1
      WRITE(3,280)SMQP1,SMVP1
      WRITE(3,290)SMQ1,SMV1
      WRITE(3,300)SMQ10,SMV10
      WRITE(3,310)SMQ100,SMV100
      WRITE(3,320)DSPCE
260   FORMAT(' VA/Q OF ZERO       ',F16.3,8X,'        ZERO')
270   FORMAT(' VA/Q RANGE    0  TO  .01'F11.3,F20.3)
280   FORMAT(' VA/Q RANGE   .01 TO  .1',F12.3,F20.3)
290   FORMAT(' VA/Q RANGE   .1 TO  1.',F13.3,F20.3)
300   FORMAT(' VA/Q RANGE  1.0 TO 10.',F13.3,F20.3)
310   FORMAT(' VA/Q RANGE 10. TO 100.',F13.3,F20.3)
320   FORMAT(' VA/Q OF INFINITY               ZERO     ',F15.3/)
      SUMQVQ=0.0
      SUMVVQ=0.0
      SUMQ=0.0
      SUMV=0.0
      DO 330, I=2,NV
      SUMQVQ=SUMQVQ + QQ(I)*ALOG(VAQ(I))
      SUMVVQ=SUMVVQ + V(I)*ALOG(VAQ(I))
      SUMQ=SUMQ + QQ(I)
330   SUMV=SUMV + V(I)
      IF(SUMQ.LE.0.0.OR.SUMV.LE.0.0) RETURN
      FQ=SUMQVQ/SUMQ
      FV=SUMVVQ/SUMV
      QBAR=EXP(FQ)
      VBAR=EXP(FV)
      SUMVRQ=0.0
      SUMVRV=0.0
      SUMSKQ=0.0
      SUMSKV=0.0
      DO 340, I=2,NV
      SUMVRQ=SUMVRQ + QQ(I)*(ALOG(VAQ(I)) - FQ)**2
      SUMVRV=SUMVRV + V(I)*(ALOG(VAQ(I)) - FV)**2
      SUMSKQ=SUMSKQ + QQ(I)*(ALOG(VAQ(I)) - FQ)**3
      SUMSKV=SUMSKV + V(I)*(ALOG(VAQ(I)) - FV)**3
340   CONTINUE
      QSD=SQRT(SUMVRQ/SUMQ)
      VSD=SQRT(SUMVRV/SUMV)
      QSKEW = SUMSKQ/SUMQ
      VSKEW = SUMSKV/SUMV
      WRITE(3,350)QBAR,QSD,QSKEW,VBAR,VSD,VSKEW
350   FORMAT(/,'       MEAN OF BLOOD FLOW  DISTRIBUTION =',F7.2,/,
     1' 2nd MOMENT OF BLOOD FLOW  DISTRIBUTION =',F7.2,/,
     2' 3rd MOMEMT OF BLOOD FLOW  DISTRIBUTION =',F7.2,//,
     3'       MEAN OF VENTILATION DISTRIBUTION =',F7.2/,
     4' 2nd MOMENT OF VENTILATION DISTRIBUTION =',F7.2/,
     5' 3rd MOMENT OF VENTILATION DISTRIBUTION =',F7.2,//)
      DO 360, I=1,NVAQS
      V(I)=V(I)*VT
360   QQ(I)=QQ(I)*QT
      VA=VT-V(NVAQS)
C      Calculation of max possible deadspace ventilation
C      by John Evans' recursion method
      DQ(NGAS1)=QT
      DV(1)=0.0
      DO 370, LL=1,NGASES
      DKK(NGASES,LL)=RAD(LL)*QT
C      DKK(NGASES,LL)=(AD(LL)/WEIGHT(LL))*QT-THIS IS NOT ACCURATE ENOUGH!
370   CONTINUE
      DO 380, KK=1,NGASES-1
      K=NGASES-KK
      K1=K+1
      DQ(K1)=(DQ(K1+1)-DKK(K1,K1))/DKK(K1,K1)
      DO 380,I=1,K
      DKK(K,I)=(PC(I)*(DKK(K1,I)-DKK(K1,K1)))/(PC(I)*DKK(K1,K1)-
     1 PC(K1)*DKK(K1,I))
      IF(K.NE.1) GO TO 380
      DQ(1)=(DQ(K1)-DKK(K,K))/DKK(K,K)
380   CONTINUE
      DO 390, L=1,NGASES
      L1=L+1
      DV(L1)=DKK(L,L)*(DV(L)+PC(L)*(DQ(L)+1.0)*DQ(L))
390   CONTINUE
      VD=VT-DV(NGAS1)
      DED=VD/VT
C**********
C     MEASURE OF DISPERSION DIRECTLY FROM DATA, AS THE SUM OF SQUARES
C     OF THE DIFFERENCES BETWEEN HOMOGENEOUS RETENTIONS AND THE BEST FIT
C     VALUES OUT OF SMOOTH.
C**********
      WRITE(3,400)
400   FORMAT(' GAS',4X,'PC',7X,'R',7X,'RH',4X,'R - RH',5X,'E',
     &7X,'E*',6X,'EH',3X,'EH - E*',1X,'R - E*')
      DISR=0.0
      DISE=0.0
      DISRE=0.0
      DO 410, I=1,NGASES
      RH=PC(I)/(PC(I)+VA/QT)
      EH=RH
C      ADD=AD(I)/WEIGHT(I)-THIS IS NOT ACCURATE ENOUGH!
      ADD=RAD(I)
      EE=PC(I)*QT*(1.0-ADD)/VT
      EXC=EE/(1.0-DED)
      DIFFR=ADD-RH
      DIFFE=EH - EXC
      DIFFRE=ADD - EXC
      DISR=DISR+DIFFR*DIFFR
      DISE=DISE+DIFFE*DIFFE
      DISRE=DISRE+DIFFRE*DIFFRE
      WRITE(3,420)I,PC(I),ADD,RH,DIFFR,EE,EXC,EH,DIFFE,DIFFRE
410   CONTINUE
420   FORMAT(I2,F10.5,8F8.5)
      DISPR=100.0*SQRT(DISR/(FLOAT(NGASES)))
      DISPE=100.0*SQRT(DISE/(FLOAT(NGASES)))
      DISPRE=100.0*SQRT(DISRE/(FLOAT(NGASES)))
      WRITE(3,430) VD,DED
430   FORMAT(/' MAX POSSIBLE DEADSPACE VENTILATION =',F7.1,
     1' L/MIN,  OR AS A FRACTION =',F5.3/)
      WRITE(3,440)DISPR,DISPE,DISPRE
440   FORMAT(' DISPERSION DIRECTLY FROM DIFFERENCES BETWEEN:',//,
     1'  BEST FIT   RETENTIONS & HOMOGENEOUS RETENTIONS IS:',F7.2,/,
     2' HOMOGENEOUS EXCRETIONS &  BEST FIT   EXCRETIONS IS:',F7.2,/,
     3'  BEST FIT   RETENTIONS *  BEST FIT   EXCRETIONS IS:',F7.2///)
      IF(IC.EQ.2)  GO TO 450
      IF(IRORE.EQ.0 .AND. V(NVAQS).GE.0.0) GO TO 450
      IF(IRORE.NE.0 .AND. QQ(1).GE.0.0) GO TO 450
      IC=2
      GO TO 120
450   CONTINUE
      YMAX=0.0
      DO 460, J=2,NVAQS
      IF(YMAX.GE.QQ(J)) GO TO 460
      YMAX=QQ(J)
460   CONTINUE
      DO 470, J=1,NV
      IF(YMAX.GE.V(J)) GO TO 470
      YMAX=V(J)
470   CONTINUE
      YMAX=1.25*YMAX
      YMAXV=YMAX
      VAQ(1)=0.0002
      VAQ(NVAQS)=990.0
      LINES=36      
      IF(YMAX.EQ.0.0) GO TO 480
      IPLCHR='*'
      CALL PLOT(1,VAQ,QQ,YMAX,LINES,NVAQS,1,2,1,0,IPLCHR,KRUN)
      IPLCHR='O'
      CALL PLOT(1,VAQ,V,YMAXV,LINES,NV,2,2,1,0,IPLCHR,KRUN)
480   CONTINUE
      VAQ(1)=0.0
      SOLHI=1000.0
      SOLLO=0.0001
      DS=(ALOG10(SOLHI/SOLLO))/49.0
      DO 490, J=1,50
      TJ=J
490   SOL(J) = SOLLO*(10.0**(DS*(TJ-1.0)))
      DO 510 I=1,50
      CALCDR(I)=0.0
      CALCDE(I)=0.0
      DO 500, J=1,NV
      CALCDR(I)=CALCDR(I) + QQ(J)*SOL(I)/(SOL(I)+VAQ(J))
500   CALCDE(I)=CALCDE(I) + V(J)*SOL(I)/(SOL(I)+VAQ(J))
      CALCDR(I)=CALCDR(I)/QT
      CALCDE(I)=CALCDE(I)/VT
      VA=VT-V(NVAQS)
      RHOMO(I)=SOL(I)/(SOL(I) + VA/QT)
      EHOMO(I) = RHOMO(I)*VA/VT
510   CONTINUE
      LINES=36
      IPLCHR='.'
      CALL PLOT(2,SOL,CALCDR,1.0,LINES,50,1,6,1,0,IPLCHR,KRUN)
      IPLCHR='*'
      CALL PLOT(2,SOL,RHOMO,1.0,LINES,50,2,6,1,0,IPLCHR,KRUN)
      IPLCHR='O'
      IF(IRORE.EQ.0)CALL PLOT(2,PC,RAWDAT,1.0,LINES,NGASES,3,6,1,0,
     + IPLCHR,KRUN)
      IF(IRORE.NE.0)CALL PLOT(2,PC,RDATA,1.0,LINES,NGASES,3,6,1,0,
     + IPLCHR,KRUN)
      IPLCHR='.'
      CALL PLOT(2,SOL,CALCDE,1.0,LINES,50,4,6,1,0,IPLCHR,KRUN)
      IPLCHR='*'
      CALL PLOT (2,SOL,EHOMO,1.0,LINES,50,5,6,1,0,IPLCHR,KRUN)
      IPLCHR='O'
      IF(IRORE.EQ.0) CALL PLOT(2,PC,EDATA,1.0,LINES,NGASES,6,6,1,0,
     + IPLCHR,KRUN)
      IF(IRORE.NE.0) CALL PLOT(2,PC,RAWDAT,1.0,LINES,NGASES,6,6,1,0,
     + IPLCHR,KRUN)
      IF(IPLTRE.EQ.0) GO TO 540
      ZERO=0.0
      DO 520 J=1,50
      IF(J.LE.NGASES) WRITE(6,530)SOL(J),RHOMO(J),CALCDR(J),EHOMO(J),
     1CALCDE(J),PC(J),RAWDAT(J),EDATA(J)
      IF(J.GT.NGASES) WRITE(6,530)SOL(J),RHOMO(J),CALCDR(J),EHOMO(J),
     1CALCDE(J),ZERO,ZERO,ZERO
 520  CONTINUE
 530  FORMAT(8F10.4)
 540  CONTINUE
      RETURN
      END
      SUBROUTINE SMOOTH(E,PC,DATA,RAWDAT,WEIGHT,AD,IC,SUMQV,IRORE)
      DIMENSION WEIGHT(10),PC(10),AD(10),DATA(10),RAWDAT(10)
      DIMENSION IFLOW(500),Y(500)
      COMMON/VQ/V(500),Q(500),QQ(500),VAQ(500)
      DIMENSION A(500,10),WT(500),FLOW(500),H(500)
      DIMENSION C(10,10),RBAR(10),RD(10)
      COMMON/INERT/NVAQS,VT,QT,NGASES,FACT,Z,VQLO,VQHI
      DOUBLE PRECISION A,WT,FLOW,H,C,RBAR,RD
C
C     GENERATE A, THE ORIGINAL CHEBYSHEV MATRIX:  S/(S+VAQ)
C
      NV=NVAQS-1
      QTVT=QT/VT
      VTQT=VT/QT
      JLO=1
      JHI=NV
      JC=1
      IF(IRORE.EQ.0) GO TO 10
      JLO=2
      JHI=NVAQS
      JC=NVAQS
 10   SSQPRE=1000000.0
      SSLOOP=1000000.0
      NEQNS=NGASES+IC
      NEQN1=NEQNS+1
      NEQN2=NEQNS+2
      DO 20 I=1,NGASES
      A(NVAQS,I)=0.0
      DO 20  J=1,NV
 20   A(J,I) = PC(I)/(PC(I) + VAQ(J))
      DO 30, J=JLO,JHI
      A(J,NGASES+1) = 1.0
      IF(IC.EQ.2 .AND. IRORE.EQ.0) A(J,NEQNS)=VAQ(J)*QTVT
 30   IF(IC.EQ.2 .AND. IRORE.NE.0) A(J,NEQNS)=VTQT/VAQ(J)
      DO 40 J=1,IC
      DATA(NGASES+J) = 1.0
 40   WEIGHT(NGASES+J) = 20000.0
      ICL=(IC-1)*NGASES + 1
      DO 50, I=ICL,NEQNS
 50   DATA(I)=DATA(I)*WEIGHT(I)
      DO 60, I=1,NEQNS
      DO 60, J=JLO,JHI
 60   A(J,I)=A(J,I)*WEIGHT(I)
      DO 70, J=2,NV
      IFLOW(J)=1
      IF(IRORE.EQ.0) WT(J)=SQRT(Z*(1.0 + QTVT*QTVT*VAQ(J)*VAQ(J)))
      IF(IRORE.NE.0) WT(J)=SQRT(Z*(1.0 + VTQT*VTQT*
     & (1.0/VAQ(J))*(1.0/VAQ(J))))
 70   CONTINUE
      IFLOW(JC)=1
      WT(1)=1.0
      WT(NVAQS)=1.0
      DO 80, I=1,NEQNS
      DO 80, J=JLO,JHI
 80   A(J,I)=A(J,I)/WT(J)
      IF(IC.EQ.2 .AND. IRORE.EQ.0) WRITE(3,90)
 90   FORMAT(' SMOOTH RERUN WITH A NON-NEGATIVE DEADSPACE CONSTRAINT -
     & AN 8th EQN WITH TOTAL V=1')
      IF(IC.EQ.2 .AND. IRORE.NE.0) WRITE(3,100)
100   FORMAT(' SMOOTH RERUN WITH A NON-NEGATIVE SHUNT CONSTRAINT -
     & AN 8th EQN WITH TOTAL Q=1')
      IF(IRORE.EQ.0) WRITE(3,110)
110   FORMAT(/3X,'ITN',2X,'LOOP',9X,'TOTAL SSQ',12X,'FIT TO R',13X,
     1'SUM Q*Q')
      IF(IRORE.NE.0) WRITE(3,120)
120   FORMAT(/3X,'ITN',2X,'LOOP',9X,'TOTAL SSQ',12X,'FIT TO E',13X,
     1'SUM V*V')
      ITER=0
      IREP=1
C
C     GENERATE THE UPPER HALF OF A*A TRANSPOSE, NOTING THAT IT IS SYMMETRIC
C
      LOOP=0
130   LOOP=LOOP+1
      IF(LOOP.GT.1) SSLOOP=SSQ
      DO 150 I=1,NEQNS
      DO 150 J=1,I
      C(J,I)=0.0
      DO 140 K=2,NV
      IF(IFLOW(K).EQ.0) GO TO 140
      C(J,I) = C(J,I) + A(K,I)*A(K,J)
140   CONTINUE
      IF(I.EQ.J) C(J,I) = 1.0 + C(J,I)
150   CONTINUE
C
C     THE SMOOTHING FACTOR IS CALLED Z. WE GENERATE MATRIX  C, WHICH IS
C     IDENTITY PLUS A x AT DIVIDED BY Z, PLUS A DATA COLUMN & A SHUNT
C     OR DEADSPACE SPECIAL COMPARTMENT COLUMN
C
      DO 160 I=1,NEQNS
      C(I,NEQN1) = DATA(I)
      IF(IFLOW(JC).GT.0) C(I,NEQN2) = A(JC,I)
160   CONTINUE
C
C     NOW SOLVE THE UNCONSTRAINED SYSTEM C x RD = DATA, USING GAUSSIAN
C     ELIMINATION WITH BACK-SUBSTITUTION
C
      DO 180, I=1,NEQNS-1
      I1=I+1
      DO 180 J=I1,NEQNS
      DO 170 K=J,NEQN1
      C(J,K) = C(J,K) -  C(I,J)*C(I,K)/C(I,I)
170   CONTINUE
      IF(IFLOW(JC).GT.0) C(J,NEQN2)=C(J,NEQN2)-
     & C(I,J)*C(I,NEQN2)/C(I,I)
180   CONTINUE
      RD(NEQNS) = C(NEQNS,NEQN1)/C(NEQNS,NEQNS)
      IF(IFLOW(JC).GT.0) RBAR(NEQNS)=C(NEQNS,NEQN2)/C(NEQNS,NEQNS)
      DO 200 I=1,NEQNS-1
      RD(NEQNS-I) = C(NEQNS-I,NEQN1)
      IF(IFLOW(JC).GT.0) RBAR(NEQNS-I) = C(NEQNS-I,NEQN2)
      NN1 = NEQN1 -I
      DO 190, K=NN1,NEQNS
      RD(NEQNS-I) = RD(NEQNS-I) - C(NEQNS-I,K)*RD(K)
      IF(IFLOW(JC).GT.0) RBAR(NEQNS-I) = RBAR(NEQNS-I) -
     & C(NEQNS-I,K)*RBAR(K)
190   CONTINUE
      RD(NEQNS-I) = RD(NEQNS-I)/C(NEQNS-I,NEQNS-I)
      IF(IFLOW(JC).GT.0) RBAR(NEQNS-I)=
     & RBAR(NEQNS-I)/C(NEQNS-I,NEQNS-I)
200   CONTINUE
      IF(IFLOW(JC).EQ.0) GO TO 230
      A1=0.0
      A2=0.0
      DO 210, I=1,NEQNS
      A1=A1 + A(JC,I)*RD(I)
      A2=A2 + A(JC,I)*RBAR(I)
210   CONTINUE
      A0=A1/A2
      DO 220, I=1,NEQNS
220   RD(I)=RD(I)-A0*RBAR(I)
C
C     NOW COMES CALCULATION OF THE Q (OR V) VALUES
C
230   DO 240 J=JLO,JHI
      FLOW(J)=0.0
      DO 240 I=1,NEQNS
      FLOW(J)=FLOW(J) + RD(I)*A(J,I)
240   CONTINUE
      IF(IFLOW(JC).GT.0) FLOW(JC) = A0
      SUM1=0.0
      DO 250 I=1,NEQNS
      SUM1=SUM1+RD(I)*RD(I)
250   CONTINUE
      SUM2=0.0
      DO 260 J=2,NV
      IF(IFLOW(J).EQ.0) GO TO 260
      SUM2=SUM2+FLOW(J)*FLOW(J)
260   CONTINUE
      SSQ=SUM1+SUM2
      WRITE(3,270)ITER,LOOP,SSQ,SUM1,SUM2
270   FORMAT(2I5,3F20.6)
C
C     WRITE(3,272)(IFLOW(JC),IFLOW(J),J=2,NV)
C272  FORMAT(10(I8,4X))
C     WRITE(3,274)FLOW(JC),((FLOW(JJ)/WT(JJ)),JJ=2,NV)
C274  FORMAT(10F12.5)
C
C     HAVING CALCULATED Q OR V VALUES, WE NOW NEED TO ENFORCE THE
C     NON-NEGATIVITY CONSTRAINT:
C
      IF(IREP.EQ.1) GO TO 280
      GO TO 300
280   IREP=2
      DO 290, I=JLO,JHI
      IF(IFLOW(I).EQ.1 .AND. FLOW(I).LE.0.0) IREP=1
      IF(IFLOW(I).EQ.1 .AND. FLOW(I).LE.0.0) IFLOW(I)=0
290   CONTINUE
      IF(IREP.EQ.1) GO TO 130
300   IREP=3
      XMIN=1.0
      DO 320 I=JLO,JHI
      IF(IFLOW(I).GT.0 .AND. FLOW(I).LE.0.0) GO TO 310
      GO TO 320
310   IREP=2
      Y(I)=H(I)/(H(I)-FLOW(I))
      IF(XMIN.GT.Y(I)) XMIN=Y(I)
320   CONTINUE
      IF(IREP.EQ.3) GO TO 350
      DO 340 I=JLO,JHI
      IF(IFLOW(I).EQ.0) GO TO 340
      IF(FLOW(I).GT.0.0) GO TO 330
      Y(I)=H(I)/(H(I)-FLOW(I))
      IF(Y(I).EQ.XMIN) IFLOW(I)=0
330   H(I)= (1.0-XMIN)*H(I)+XMIN*FLOW(I)
340   CONTINUE
      GO TO 130
350   CONTINUE
      ITER=ITER+1
      SUM1=0.0
      DO 360 I=1,NEQNS
      SUM1=SUM1+RD(I)*RD(I)
360   CONTINUE
      SUM2=0.0
      DO 370 J=2,NV
      IF(IFLOW(J).EQ.0) GO TO 370
      SUM2=SUM2+FLOW(J)*FLOW(J)
370   CONTINUE
      SSQ=SUM1 + SUM2
C********************************
      IF(SSQ.GE.SSQPRE) GO TO 390
C********************************
      SSQPRE=SSQ
      DO 380 I=JLO,JHI
      IF(IFLOW(I).GT.0) H(I)=FLOW(I)
      IF(IFLOW(I).GT.0) IFLOW(I)=2
      IF(IFLOW(I).EQ.0 .AND. FLOW(I).GT.0.0) IREP=1
      IF(IFLOW(I).EQ.0 .AND. FLOW(I).GT.0.0) IFLOW(I)=1
      IF(IFLOW(I).EQ.0) H(I)=0.0
380   CONTINUE
      IF(ITER.EQ.99) GO TO 410
      IF(IREP.EQ.1) GO TO 130
390   CONTINUE
C
C     CALCULATE THE ERROR AND THE APPROXIMATING DATA
C
      DO 400 I=2,NV
400   FLOW(I)=FLOW(I)/WT(I)
410   WRITE(3,420)ITER
420   FORMAT(/' ITERATION NUMBER =',I3)
      SUMQV=0.0
      SUME8=0.0
      IF(IRORE.NE.0) GO TO 470
      DO 430 J=1,NV
      IF(IFLOW(J).EQ.0) FLOW(J)=0.0
      QQ(J)=SNGL(FLOW(J))
      SUMQV=SUMQV + QQ(J)
      SUME8=SUME8+QQ(J)*VAQ(J)*QTVT
430   CONTINUE
      WRITE(3,440) SUMQV
440   FORMAT(' TOTAL BLOOD FLOW ='F10.6)
      IF(IC.EQ.2) WRITE(3,450) SUME8
450   FORMAT(' TOTAL VENTILATION='F10.6)
      WRITE(3,460)
460   FORMAT(/6X,'PC'7X,'RETENTIONS',5X,'BEST FIT'7X,'ERROR',
     15X,'RAW DATA',7X,'ERROR')
      GO TO 520
470   DO 480 J=2,NVAQS
      IF(IFLOW(J).EQ.0) FLOW(J)=0.0
      V(J)=SNGL(FLOW(J))
      SUMQV=SUMQV + V(J)
      SUME8=SUME8+V(J)*VTQT/VAQ(J)
480   CONTINUE
      WRITE(3,490)SUMQV
490   FORMAT(' TOTAL VENTILATION='F10.6)
      IF(IC.EQ.2) WRITE(3,500) SUME8
500   FORMAT(' TOTAL BLOOD FLOW ='F10.6)
      WRITE(3,510)
510   FORMAT(/6X,'PC'7X,'EXCRETIONS',5X,'BEST FIT'7X,'ERROR',
     15X,'RAW DATA',7X,'ERROR')
520   E=0.0
      DO 530 I=1,NEQNS
      E=E+RD(I)*RD(I)
      AD(I)=DATA(I)-RD(I)
530   CONTINUE
      DO 540 I=1,NEQNS
      S=PC(I)
      IF(I.GT.NGASES) S=0.0
      RAWERR=AD(I)/WEIGHT(I) - RAWDAT(I)
      WRITE(3,550)S,DATA(I),AD(I),RD(I),RAWDAT(I),RAWERR
540   CONTINUE
550   FORMAT(F10.4,F15.3,F13.3,F12.3,F13.5,F12.5)
      WRITE(3,560)E
560   FORMAT(/' REMAINING SUM OF SQUARES =',1PE10.2)
      RETURN
      END
      SUBROUTINE PLOT(IM,XX,Y,YMAX,LINES,LAST,NO,MOST,LOGX,
     1LOGY,ISYMBO,KRUN)
      DIMENSION XX(*),Y(*),ZX(8),IGRAPH(61,40),X(500)
      DIMENSION LRUN(10),INAM1(15),INAM2(15)
      DIMENSION IHEAD1(36),IHEAD2(36)
      CHARACTER INAM1,INAM2,IHEAD1,IHEAD2,IHEAD,IOK,IBLANK,IBORDE,
     1LRUN,ISYMBO,IGRAPH,IPOINT
      DATA IHEAD1/' ',' ','C','O','M','P',' ',' ',' ','V','E','N','T',
     1' ',' ','O','R',' ',' ','B','L','O','O','D','F','L','O','W',
     1' ',' ','L','/','M','I','N',' '/
      DATA IHEAD2/' ',' ','R','E','T','E','N','T','I','O','N',
     1' ',' ',' ',' ',' ','A','N','D',' ',' ',' ',' ',' ','E','X',
     1'C','R','E','T','I','O','N',' ',' ',' '/
      DATA IBORDE/'.'/
      DATA IBLANK/' '/
      DATA INAM1/'V','E','N','T','I','L','A','T','I','O','N',
     1' ','=' ,' ','O'/
      DATA INAM2/'B','L','O','O','D','F','L','O','W',' ',' ',
     1' ','=',' ','*'/
      DATA LRUN/'0','1','2','3','4','5','6','7','8','9'/
      IWID=61
      RWID=IWID-1
      IF(IM.EQ.2) GO TO 20  
      DO 10 I=7,21
      IGRAPH(I,3)=INAM1(I-6)
  10  IGRAPH(I,5)=INAM2(I-6)
  20  CONTINUE
      IF(KRUN.LT.10) IGRAPH(55,3)=LRUN(KRUN+1)
      IF(KRUN.LT.20.AND.KRUN.GE.10) IGRAPH(55,3)=LRUN(2)
      IF(KRUN.LT.20.AND.KRUN.GE.10) IGRAPH(56,3)=LRUN(KRUN-9)
      IF(KRUN.LT.30.AND.KRUN.GE.20) IGRAPH(55,3)=LRUN(3)
      IF(KRUN.LT.30.AND.KRUN.GE.20) IGRAPH(56,3)=LRUN(KRUN-19)
      IPOINT=ISYMBO
      YL=YMAX
      YS=0.0
      MATRIX=IWID*LINES
      A=LINES-1
      YSCALE=(YL-YS)/A
      XL=1000.0
      XS=0.0001
      IF(LOGX) 30,50,30
  30  DO 40 I=1,LAST
  40  X(I)=ALOG10(XX(I))
      XS=ALOG10(XS)
      XL=ALOG10(XL)
      XSCALE=(XL-XS)/RWID
  50  IF(LOGY) 60,80,60
  60  DO 70 I=1,LAST
  70  Y(I)=ALOG10(Y(I))
      YS=ALOG10(YS)
      YL=ALOG10(YL)
  80  IF(NO-1) 120,90,120
  90  CONTINUE
      MATRIX=IWID*LINES
      DO 100 I=1,LINES
      DO 100 J=1,IWID
 100  IGRAPH(J,I)=IBLANK
      XSCALE=(XL-XS)/RWID
      A=LINES-1
      YSCALE=(YL-YS)/A
      DO 110 I=1,LINES
      IGRAPH(1,I)=IBORDE
 110  IGRAPH(IWID,I)=IBORDE
 120  DO 170 I=1,LAST
      IF(XL-X(I)) 170,130,130
 130  IF(X(I)-XS) 170,140,140
 140  IF(YL-Y(I)) 170,150,150
 150  IF(Y(I)-YS) 170,160,160
 160  IX=(X(I)-XS)/XSCALE + 1.5
      IY=(Y(I)-YS)/YSCALE + 0.5
      IY=LINES-IY
      IGRAPH(IX,IY)=IPOINT
 170  CONTINUE
      IF(NO-MOST) 180,190,180
 180  RETURN
 190  CONTINUE
      WRITE(3,320)
      YES=YL+YSCALE
      DO 200 I=1,LINES
      YES=YES-YSCALE
      IF(IM.EQ.1) IHEAD=IHEAD1(I)
      IF(IM.EQ.2) IHEAD=IHEAD2(I)
 200  WRITE(3,330)YES,IHEAD,(IGRAPH(J,I),J=1,IWID)
      WRITE(3,340)
      ZX(1)=0.0
      IF(IM.EQ.2) ZX(1)=0.00013
      ZX(2)=0.0013
      ZX(3)=0.013
      ZX(4)=0.13
      ZX(5)=1.0
      ZX(6)=10.0
      ZX(7)=100.0
      ZX(8)=1000.0
      WRITE(3,350)(ZX(K),K=1,8)
      IF(LOGX) 250,220,250
 220  IF(LOGY) 230,310,230
 230  WRITE(3,240)
 240  FORMAT(26H Y IS PLOTTED ON LOG SCALE)
      GO TO 310
 250  IF(LOGY) 260,280,260
 260  WRITE(3,270)
 270  FORMAT(34H X AND Y ARE PLOTTED ON LOG SCALES)
      GO TO 310
 280  CONTINUE
      IF(IM.EQ.1) WRITE(3,290)
      IF(IM.EQ.2) WRITE(3,300)
 290  FORMAT(/21X'VENTILATION - PERFUSION  RATIO,  LOG SCALE'///)
 300  FORMAT(/20X'BLOOD:GAS PARTITION COEFFICIENT,  LOG SCALE'/////)
 310  RETURN
 320  FORMAT(11H   Y VALUES 3X,1H.,7X,1H.,7X,1H.,7X,1H.,7X,1H.,
     17X,1H.,7X,1H.,7X,1H.)
 330  FORMAT(1H F8.3,1X,A1,1X,101A1)
 340  FORMAT(14X,1H.,7X,1H.,7X,1H.,7X,1H.,7X,1H.,7X,1H.,8X,1H.,7X,
     11H.)
 350  FORMAT(F17.4,F8.3,F8.2,F7.1,F8.1,F8.1,F10.1,F9.1)
      RETURN
      END

      SUBROUTINE BLOOD(PO2,PCO2,O2C,CO2C)
      COMMON/OXY1/HB,HCRIT,TEMP,APH,BPH,APCO2,BPCO2,KOUNT,DP50,PIO2,SO2
      PH1=PH(PCO2,0.0)
      Y=0.003*HB*(1.0-SATURA(PO2,PCO2,PH1)/100.0)
      PH2=PH(PCO2,Y)
      SATRN=SATURA(PO2,PCO2,PH2)
      O2C=0.0139*HB*SATRN + SO2*PO2
      CO2C=CO2CON(PCO2,PH2,SATRN)
      RETURN
      END
      FUNCTION PH(PCO2,Y)
      COMMON/OXY1/HB,HCRIT,TEMP,APH,BPH,APCO2,BPCO2,KOUNT,DP50,PIO2,SO2
      IF(PCO2.LT.0.001) PCO2=0.001
      IF(APH-1.0) 10,10,20
  10  PH=7.59 + Y - 0.2741*ALOG(PCO2/20.0)
      GO TO 30
  20  PH=BPH+Y+(APH-BPH)*ALOG(PCO2/BPCO2)/ALOG(APCO2/BPCO2)
  30  RETURN
      END
      FUNCTION CO2CON(PCO2,PHE,SATN)
      COMMON/OXY1/HB,HCRIT,TEMP,APH,BPH,APCO2,BPCO2,KOUNT,DP50,PIO2,SO2
      P=7.4-PHE
      PK=6.086+0.042*P+(38.0-TEMP)*(0.00472+0.00139*P)
      SOL=0.0307 + 0.00057*(37.0-TEMP) + 0.00002*(37.0-TEMP)*(37.0-TEMP)
      DOX=0.59+0.2913*P-0.0844*P*P
      DR=0.664+0.2275*P-0.0938*P*P
      DDD=DOX+(DR-DOX)*(1.-SATN/100.0)
      CP=SOL*PCO2*(1.0+10.0**(PHE-PK))
      CCC=DDD*CP
      CO2CON=(HCRIT*CCC*0.01 + (1.0-HCRIT*0.01)*CP)*2.22
      RETURN
      END
      FUNCTION SATURA(PO2,PCO2,PHE)
      COMMON/OXY1/HB,HCRIT,TEMP,APH,BPH,APCO2,BPCO2,KOUNT,DP50,PIO2,SO2
      KOUNT=KOUNT+1
      A1=-8532.229
      A2=2121.401
      A3=-67.07399
      A4=935960.9
      A5=-31346.26
      A6=2396.167
      A7=-67.10441
      B=0.43429*ALOG(40.0/PCO2)
      X=PO2*10.0**(0.024*(37.0-TEMP)+0.4*(PHE-7.4)+0.06*B)
      X=26.8*X/(26.8+DP50)
      IF(X-10.0) 10,20,20
  10  SAT=0.003683*X + 0.000584*X*X
      GO TO 30
  20  SAT=(X*(X*(X*(X+A3)+A2)+A1))/(X*(X*(X*(X+A7)+A6)+A5)+A4)
  30  SATURA=100.0*SAT
      RETURN
      END
      SUBROUTINE SAMEO2(PPO,PPCO,ARTO2C,CO2CT2)
      COMMON/OXY1/HB,HCRIT,TEMP,APH,BPH,APCO2,BPCO2,KOUNT,DP50,PIO2,SO2
      E=0.0
      F=PIO2+10.0
  10  G=(E+F)/2.0
      CALL BLOOD(G,PPCO,O2CNT2,CO2CT2)
      A10=ABS(O2CNT2-ARTO2C)
      IF(A10-0.001) 50,50,20  
  20  IF(O2CNT2-ARTO2C) 30,50,40
  30  E=G
      GO TO 10 
  40  F=G
      GO TO 10 
  50  CONTINUE
      PPO=G
      RETURN
      END
      SUBROUTINE FNDTEN(PPO,PPCO,ARTO2C,ARTCO2)
      DIMENSION PI(4)
      PI(1)=10.0
      PI(2)=1.0
      PI(3)=0.1
      PI(4)=0.01
      PPCO=0.0
      DO 20 K=1,4
  10  PPCO=PPCO+PI(K)
      CALL SAMEO2 (PPO,PPCO,ARTO2C,CO2CT2)
      IF(CO2CT2-ARTCO2) 10,20,20
  20  PPCO=PPCO-PI(K)
      RETURN
      END
      SUBROUTINE DETERM(U,F,G,DET)
      DIMENSION U(3),F(3),G(3),W(3)
      I=1
      J=2
      K=3
  10  W(I)=U(I)*(F(J)*G(K) - F(K)*G(J))
      IF(I-3) 20,50,50
  20  IF(I-1) 30,30,40
  30  I=2
      J=3
      K=1
      GO TO 10
  40  I=3
      J=1
      K=2
      GO TO 10
  50  DET=0.0
      DO 60 I=1,3
  60  DET=DET+W(I)
      RETURN
      END
      SUBROUTINE SUMUP(KRUN)
      COMMON/INERT/NVAQS,VT,QT,NGASES,FACT,Z,VQLO,VQHI
      COMMON/OXY1/HB,HCRIT,TEMP,APH,BPH,APCO2,BPCO2,KOUNT,DP50,PIO2,SO2
      COMMON/OXY2/PB,FIO2,PICO2,FICO2,VS,QS,SKEW,GVO2,GVCO2,TOL,
     + PVO2,PVCO2,FMVO2,FMVCO2,PVN2,ALPHA,SHUNT,QR,GVAQ,FVQ,PAO2,
     + PACO2,O2CON,CCO2,PO2,PCO2,FVO2,FVCO2,RZ,RM,ARTO2C,ARTCO2,AMO2C
      COMMON/VQ/V(500),Q(500),QQ(500),VAQ(500)
      COMMON/BOHR/DM,VC,BETA,RNT,DDLO2,DDLCO2,PMAO2,PMACO2,PO2B,PCO2B,
     +IBOHR,CAIII,IPRN,ARTPM,IWARN,IWARN2
      COMMON/O2ARAY/OO2CON(500),OCCO2(500),FVQQ(500),PN22(500),
     +PCO22(500),PO22(500),RZZ(500),PBO2(500),PBCO2(500)
      CALL BLOOD(PVO2,PVCO2,FMVO2,FMVCO2)
      KNT=0
      DM1=0.020*GVO2
      DM2=0.025*GVO2
      DM3=0.030*GVO2
C     
C     ALTERNATIVE FIRST THREE GUESSES COULD BE:
C
C     0.8*QT
C     1.0*QT
C     1.5*QT
C 
  10  KNT=KNT+1
      IF(KNT.EQ.1) DM=DM1
      IF(KNT.EQ.2) DM=1.2*DM1
      IF(KNT.EQ.3) DM=DM3 
  20  CC=0.0
      DD=0.0
      DLO2=0.0
      DLCO2=0.0
      IWARN2=0
      DO 30 I=1,NVAQS
      FVQQ(I)=0.0
      PO22(I)=0.0
      PCO22(I)=0.0
      PN22(I)=0.0  
      RZZ(I)=0.0
      PBO2(I)=0.0
      PBCO2(I)=0.0
      OO2CON(I)=0.0
      OCCO2(I)=0.0
  30  CONTINUE
      IF(IBOHR.EQ.2) WRITE(*,40)KRUN
  40  FORMAT(//,3X'#'5X'PAO2'6X'PaO2'6X'PACO2'5X'PaCO2         SET:'I5/)
      DO 80 I=2,NVAQS-1
      IF(IBOHR.EQ.2.AND.Q(I).LE.1.E-6) GO TO 80
      GVAQ=VAQ(I)
      FI=FIO2+FICO2
      SUM=ABS(FI-1.0)
      IF(SUM.LE.0.0001) GO TO 60
      CALL VQSOLN
      IF (IWARN.EQ.1) IWARN2=1
      IF(IBOHR.EQ.2) WRITE(*,50)I,PAO2,PO2B,PACO2,PCO2B
  50  FORMAT(' ',I3,4F10.2)
      GO TO 70
  60  CALL PUREO2
  70  CONTINUE
      PBO2(I)=PO2B
      PBCO2(I)=PCO2B
      IF(IBOHR.EQ.2) CALL BLOOD(PO2B,PCO2B,O2CON,CCO2)
      FVQQ(I)=FVQ
      PO22(I)=PAO2
      PCO22(I)=PACO2
      PN22(I)=PIO2/FIO2-PAO2-PACO2
      RZZ(I)=RZ
      OO2CON(I)=O2CON
      OCCO2(I)=CCO2
      CC=CC+OO2CON(I)*Q(I)
      DD=DD+OCCO2(I)*Q(I)
      DLO2=DLO2+DDLO2*Q(I)
      DLCO2=DLCO2+DDLCO2*Q(I)
  80  CONTINUE
      FVQQ(1)=0.0
      PO22(1)=PVO2
      PCO22(1)=PVCO2
      PBO2(1)=PVO2
      PBCO2(1)=PVCO2
      RZZ(1)=0.0
      PN22(1) = PIO2/FIO2-PVO2-PVCO2
      OO2CON(1) = FMVO2
      OCCO2(1) = FMVCO2
      FVQQ(NVAQS) = 30000.0
      PO22(NVAQS) = PIO2
      PCO22(NVAQS) = PICO2
      PN22(NVAQS) = PIO2/FIO2-PIO2-PICO2
      RZZ(NVAQS) = 0.0
      OO2CON(NVAQS) = 0.0
      OCCO2(NVAQS) = 0.0
      Q(NVAQS) = 0.0
      CC=CC+OO2CON(1)*Q(1)
      DD=DD+OCCO2(1)*Q(1)
      ARTO2C = CC/QT
      ARTCO2=DD/QT
      DLO2=DLO2/(QT-Q(1))
      DLCO2=DLCO2/(QT-Q(1))
      FVO2=10.0*QT*(ARTO2C-FMVO2)
      FVCO2=10.0*QT*(FMVCO2-ARTCO2)
      CALL FNDTEN(PP1,PP2,ARTO2C,ARTCO2)
      PO2=PP1
      PCO2=PP2
      PO2ER=PO2-PMAO2
      IF(IBOHR.EQ.2) WRITE(3,90)KNT,DM,PO2ER
      IF(IBOHR.EQ.2) WRITE(*,90)KNT,DM,PO2ER
  90  FORMAT(' ITN',I3,';  DM=',F8.2,'; & PO2 ERROR=',F7.2)
      IF (IBOHR.EQ.1) GO TO 140
      IF(ABS(PO2ER).LT.0.1) GO TO 140
      IF(KNT.EQ.2) GO TO 100
      IF(KNT.EQ.3) GO TO 110
      IF(KNT.GT.3) GO TO 120
      IF(PO2ER.GT.-5.0.AND.PO2ER.LT.0.0) GO TO 99
      IF(PO2ER.LT.-10.0) DM=1.2*DM
      IF(PO2ER.LT.-10.0) GO TO 20
      IF(PO2ER.LT.-5.0) DM=1.1*DM
      IF(PO2ER.LT.-5.0) GO TO 20 
      IF(PO2ER.GT.0.0) DM=0.8*DM
      IF(PO2ER.GT.0.0) GO TO 20
  99  DM1=DM
      ERR1=PO2ER
      GO TO 10
 100  DM2=DM
      ERR2=PO2ER
      GO TO 10
 110  CONTINUE
      IF(PO2ER.LE.-10.0) DM=4.0*DM
      IF(PO2ER.GT.-10.0.AND.PO2ER.LE.-5.0) DM=2.0*DM
      IF(PO2ER.GT. -5.0.AND.PO2ER.LE.-2.0) DM=1.50*DM
      IF(PO2ER.GT. -2.0.AND.PO2ER.LT. 0.0) DM=1.1*DM
      IF(PO2ER.LT.0.0) GO TO 20
      IF(PO2ER.GE.(ARTPM-0.5)) DM=0.8*DM
      IF(PO2ER.GE.(ARTPM-0.5)) GO TO 20
      DM3=DM
      ERR3=PO2ER
      GO TO 130
 120  DM1=DM2
      ERR1=ERR2
      DM2=DM3
      ERR2=ERR3
      DM3=DM
      ERR3=PO2ER
 130  T1=(ERR1-ERR2)/(DM1-DM2)
      T2=(ERR1-ERR3)/(DM1-DM3)
      A=(T1-T2)/(DM2-DM3)
      B=T1 - A*(DM1+DM2)
      C=ERR1 - B*DM1 - A*DM1*DM1
      DM=(SQRT(B*B - 4.0*A*C) - B)/(2.0*A)
      GO TO 10
 140  CONTINUE
      RETURN
      END
      SUBROUTINE PUREO2
      COMMON/OXY1/HB,HCRIT,TEMP,APH,BPH,APCO2,BPCO2,KOUNT,DP50,PIO2,SO2
      COMMON/OXY2/PB,FIO2,PICO2,FICO2,VS,QS,SKEW,GVO2,GVCO2,TOL,
     + PVO2,PVCO2,FMVO2,FMVCO2,PVN2,ALPHA,SHUNT,QR,GVAQ,FVQ,PAO2,
     + PACO2,O2CON,CCO2,PO2,PCO2,FVO2,FVCO2,RZ,RM,ARTO2C,ARTCO2,AMO2C
      TOL1=0.001
      PCO21=PICO2
      PCO22=PICO2+PIO2
  10  PACO2=(PCO21+PCO22)/2.0
      PAO2=PIO2+PICO2-PACO2
      CALL BLOOD(PAO2,PACO2,O2CON,COCON)
      R1=(O2CON-FMVO2)/(FMVCO2-COCON)
      CON1=1.0 + FICO2*(R1-1.0)
      FVQ=8.63*(FMVCO2-COCON)*CON1/(PACO2-PICO2)
      DIFF=ABS(GVAQ-FVQ)
      IF(DIFF.LE.TOL1) GO TO 40
      IF(GVAQ-FVQ) 20,40,30
  20  PCO21=PACO2
      GO TO 10
  30  PCO22=PACO2
      GO TO 10
  40  CONTINUE
      RZ=1.0/R1
      CCO2=COCON
      PO2=PAO2
      PCO2=PACO2
      RETURN
      END
      SUBROUTINE FNDMVP(KRUN,X,Y)
      DIMENSION X(4),Y(4),F(4),G(4),U(4)
      DIMENSION VINSP(500)
      COMMON/VQ/V(500),Q(500),QQ(500),VAQ(500)
      COMMON/INERT/NVAQS,VT,QT,NGASES,FACT,Z,VQLO,VQHI
      COMMON/OXY1/HB,HCRIT,TEMP,APH,BPH,APCO2,BPCO2,KOUNT,DP50,PIO2,SO2
      COMMON/OXY2/PB,FIO2,PICO2,FICO2,VS,QS,SKEW,GVO2,GVCO2,TOL,
     + PVO2,PVCO2,FMVO2,FMVCO2,PVN2,ALPHA,SHUNT,QR,GVAQ,FVQ,PAO2,
     + PACO2,O2CON,CCO2,PO2,PCO2,FVO2,FVCO2,RZ,RM,ARTO2C,ARTCO2,AMO2C
      COMMON/BOHR/DM,VC,BETA,RNT,DDLO2,DDLCO2,PMAO2,PMACO2,PO2B,PCO2B,
     +IBOHR,CAIII,IPRN,ARTPM,IWARN,IWARN2
      COMMON/O2ARAY/OO2CON(500),OCCO2(500),FVQQ(500),PN22(500),
     +PCO22(500),PO22(500),RZZ(500),PBO2(500),PBCO2(500)
      IF(ARTPM.LE.1.0.AND.IBOHR.EQ.2) WRITE(3,1)
  1   FORMAT(' NOT ATTEMPTING BOHR INTEGRATION BECAUSE',/,' PREDICTED',
     1' ARTERIAL PO2 IS LESS THAN 1 TORR MORE THAN MEASURED')
      IF(ARTPM.LE.1.0.AND.IBOHR.EQ.2) RETURN
      IF(IBOHR.EQ.2) WRITE(3,5)
  5   FORMAT(//,19X,'***** BOHR INTEGRATION RESULTS *****'//)
      DO 10 I=1,NVAQS
      Q(I)=QQ(I)
 10   CONTINUE
      PVN2=PIO2/FIO2-PIO2-PICO2
      FBTPS=(273.0+TEMP)*PB*FIO2/(273.0*PIO2)
C      WRITE(3,20)
 20   FORMAT(/,8X'ITERATION'6X'PVO2'5X'PVCO2'5X'+VO2'4X'+VCO2')
      ITER=0
      NNN=3
 30   DO 70 N=1,NNN
      PVO2=X(N)
      PVCO2=Y(N) 
      CALL SUMUP(KRUN)
      F(N)=FVO2-GVO2
      G(N)=FVCO2-GVCO2
      IF(NNN.EQ.3) WRITE(3,20)
      WRITE(3,40)ITER,X(N),Y(N),F(N),G(N)
 40   FORMAT(11X,I3,6X,F7.2,2X,F8.2,2F9.1)
      IF(ABS(F(N))-TOL) 50,50,70
 50   IF(ABS(G(N))-TOL) 60,60,70
 60   CONTINUE
      GO TO 190
 70   CONTINUE
      DO 80 N=1,3
      U(N)=1.0
 80   CONTINUE
      CALL DETERM(U,F,G,DET1)
      DO 90 N=1,3
 90   U(N)=X(N)
      NFLAG=0
 100  CALL DETERM(U,F,G,DET2)
      IF(NFLAG-1) 110,120,120
 110  X(4)=DET2/DET1
      GO TO 130
 120  Y(4) = DET2/DET1
 130  IF(NFLAG-1) 140,160,160
 140  DO 150 N=1,3
 150  U(N)=Y(N)
      NFLAG=1
      GO TO 100
 160  DO 170 N=1,2
      J=4-N
      X(J)=X(J-1)
      Y(J)=Y(J-1)
      F(J)=F(J-1)
      G(J)=G(J-1)
 170  CONTINUE
      X(1)=X(4)
      Y(1)=Y(4)
      NNN=1
      ITER=ITER+1
      IF(ITER-10) 180,190,190
 180  GO TO 30
 190  CONTINUE
      PVVO2=X(N)
      PVVCO2=Y(N)
      CALL BLOOD(PVVO2,PVVCO2,FVVO2,FVVCO2)
      IF(IBOHR.EQ.1) WRITE(3,195)
 195  FORMAT(/2X'N'7X'VA'7X'Q'6X'VA/Q'3X'PO2'3X'PCO2'3X'O2CON',
     12X'CO2CON'3X'VINSP'3X'RQ')
      IF(IBOHR.EQ.2) WRITE(3,200)
 200  FORMAT(/2X'N'5X'VA/Q'3X'PAO2'3X'PaO2'2X'PACO2'2X
     1'PaCO2'2X'O2CON'2X'CO2CON'3X'RQ')
      PAN2=0.0
      DO 210 I=1,NVAQS-1
      IF(IBOHR.EQ.2.AND.I.EQ.1) GO TO 210
      IF(IBOHR.EQ.2.AND.Q(I).LE.1.0E-6) GO TO 210
      VINSP(I)=V(I)*PO22(I)/PIO2 + 8.63*Q(I)*(OO2CON(I)-FMVO2)/PIO2
      IF(IBOHR.EQ.1) WRITE(3,215)I,V(I),Q(I),VAQ(I),PO22(I),PCO22(I),
     1OO2CON(I),OCCO2(I),VINSP(I),RZZ(I)
      IF(IBOHR.EQ.2) WRITE(3,220)I,VAQ(I),PO22(I),PBO2(I),
     1PCO22(I),PBCO2(I),OO2CON(I),OCCO2(I),RZZ(I)
      PAN2=PAN2+Q(I)*PN22(I)
 210  CONTINUE
 215  FORMAT(I3,F10.4,F9.4,F8.4,4F7.2,F8.2,F6.2)
 220  FORMAT(I3,F9.4,6F7.2,F6.2)
      I=NVAQS
      VINSP(I) = V(NVAQS)
      IF(IBOHR.EQ.1) WRITE(3,230)I,V(I),Q(I),PO22(I),PCO22(I),
     1OO2CON(I),OCCO2(I),VINSP(I),RZZ(I)
 230  FORMAT(I3,F10.4,F9.4,'  INF   ',4F7.2,F8.2,F6.2)
      PAN2=PVN2*(1.0-QR/QT) + PAN2/QT
      CAN2=ALPHA*PAN2
      CVN2=ALPHA*PVN2
      VN2=10.0*QT*(CAN2-CVN2)
      WRITE(3,240)PAN2,PVN2,VN2
 240  FORMAT(/11X,' MIXED ARTERIAL PN2 '21X,'=',F9.1,/,
     111X,' MIXED VENOUS   PN2 '21X,'=',F9.1,/,
     211X,' N2 UPTAKE, ML/MIN  '21X,'=',F9.1/)
      RETURN
      END
      SUBROUTINE WRITE
      COMMON/VQ/V(500),Q(500),QQ(500),VAQ(500)
      COMMON/INERT/NVAQS,VT,QT,NGASES,FACT,Z,VQLO,VQHI
      COMMON/OXY1/HB,HCRIT,TEMP,APH,BPH,APCO2,BPCO2,KOUNT,DP50,PIO2,SO2
      COMMON/OXY2/PB,FIO2,PICO2,FICO2,VS,QS,SKEW,GVO2,GVCO2,TOL,
     + PVO2,PVCO2,FMVO2,FMVCO2,PVN2,ALPHA,SHUNT,QR,GVAQ,FVQ,PAO2,
     + PACO2,O2CON,CCO2,PO2,PCO2,FVO2,FVCO2,RZ,RM,ARTO2C,ARTCO2,AMO2C
      COMMON/BOHR/DM,VC,BETA,RNT,DDLO2,DDLCO2,PMAO2,PMACO2,PO2B,PCO2B,
     +IBOHR,CAIII,IPRN,ARTPM,IWARN,IWARN2
      COMMON/O2ARAY/OO2CON(500),OCCO2(500),FVQQ(500),PN22(500),
     +PCO22(500),PO22(500),RZZ(500),PBO2(500),PBCO2(500)
      IF(IBOHR.EQ.2) GO TO 160
      AA=0.0
      BB=0.0
      EE=0.0
      FFF=0.0
      DO 10 I=1,NVAQS
      AA=AA+V(I)*PO22(I)
      BB=BB+V(I)*PCO22(I)
      EE=EE+V(I)*PN22(I)
      FFF=FFF+Q(I)*PN22(I)
  10  CONTINUE
      ALVPO2=AA/VT
      ALVPCO=BB/VT
      ALVPN2=EE/VT
      ARTPN2=FFF/QT
      O2IN=FVO2
      CO2OUT=FVCO2
      OVERAL=CO2OUT/O2IN
      RMEAS=GVCO2/GVO2
      WRITE(3,20)ALVPO2,ALVPCO,O2IN,CO2OUT,OVERAL,RMEAS
  20  FORMAT(12X,'MIXED EXPIRED  PO2                      =',F10.2,/,
     112X,'MIXED EXPIRED  PCO2                     =',F10.2,/,
     112X,'OXYGEN UPTAKE                           =',F10.2,/,
     112X,'CARBON DIOXIDE OUTPUT                   =',F10.2,/,
     112X,'PREDICTED R                             =',F10.2,/,
     112X,'MEASURED R                              =',F10.2,/)
      CALL FNDTEN(ARTPO2,ARTPCO,ARTO2C,ARTCO2)
      O2DIF=ALVPO2-ARTPO2
      CO2DIF=ARTPCO-ALVPCO
      DIFN2=ARTPN2-ALVPN2
      WRITE(3,30)ARTPO2,ARTPCO,ARTO2C,ARTCO2,O2DIF,CO2DIF,DIFN2
  30  FORMAT(12X,'ARTERIAL PO2                            =',F10.2,/,
     112X,'ARTERIAL PCO2                           =',F10.2,//,
     112X,'ARTERIAL O2 CONTENT                     =',F10.2,/,
     112X,'ARTERIAL CO2 CONTENT                    =',F10.2,/,
     112X,'MIXED ALVEOLAR-ARTERIAL PO2 DIFFERENCE  =',F10.2,/,
     112X,'MIXED ALVEOLAR-ARTERIAL PCO2 DIFFERENCE =',F10.2,/,
     112X,'MIXED ALVEOLAR-ARTERIAL PN2 DIFFERENCE  =',F10.2)
      IF(OVERAL.LE.0.0) RETURN
      GRADMP=0.0
      ARTPM=ARTPO2-PMAO2
      CONPM=ARTO2C-AMO2C
      DO 140 II=1,2
      IF(II.EQ.1) WRITE(3,40)
      IF(II.EQ.2) WRITE(3,50)
  40  FORMAT(/'  IDEAL CALCULATIONS USING PREDICTED VO2 & VCO2:'/)
  50  FORMAT(/'  IDEAL CALCULATIONS USING  MEASURED VO2 & VCO2:'/)
      P1=0.0
      P2=1.2*PVCO2
      IRCNT=0
  60  PACO2=(P1+P2)/2.0
      IRCNT=IRCNT+1
      IF(II.EQ.1) RM=OVERAL
      IF(II.EQ.2) RM=RMEAS
      IF(II.EQ.2) ARTPO2=PMAO2
      FI=FIO2+FICO2
      SUM=ABS(FI-1.0)
      IF(SUM.LE.0.0001) GO TO 70 
      GO TO 80 
  70  PAO2=PIO2-PACO2+PICO2
      GO TO 90 
  80  PAO2=PIO2*RM+PACO2*FIO2*(1.0-RM)+PICO2-PACO2
      PAO2=PAO2/(RM+FICO2*(1.0-RM))
  90  CONTINUE
      CALL BLOOD(PAO2,PACO2,O2CONE,CCO2E)
      IF(O2CONE.EQ.FMVO2) GO TO 110
      BLOODR=(FMVCO2-CCO2E)/(O2CONE-FMVO2)
      DIFF=ABS(RM-BLOODR)
      IF(DIFF.LE.0.001) GO TO 110
      IF(IRCNT.GT.50) GO TO 110
      IF(BLOODR.GT.RM) GO TO 100
      P2=PACO2
      GO TO 60 
 100  P1=PACO2
      GO TO 60 
 110  CONTINUE
      CON1=1.0+FICO2*(RM-1.0)
      GVAQ=8.63*(FMVCO2-CCO2E)*CON1/(PACO2-PICO2)
      PO2IDE=PAO2
      PCO2ID=PACO2
      DEALDI=PO2IDE-ARTPO2
      DEALO2=O2CONE
      IF(II.EQ.1) GRADMP=GRADMP-DEALDI
      IF(II.EQ.2) GRADMP=GRADMP+DEALDI
      ALVDS=100.0*(PCO2ID-ALVPCO)/(PCO2ID-PICO2)
      QSQT=0.0
      IF(DEALO2.EQ.FMVO2) GO TO 120
      QSQT=100.0*(DEALO2-ARTO2C)/(DEALO2-FMVO2)
      IF(II.EQ.2) QSQT=100.0*(DEALO2-AMO2C)/(DEALO2-FMVO2)
 120  WRITE(3,130)PO2IDE,PCO2ID,DEALDI,DEALO2,ALVDS,QSQT,KOUNT,GVAQ
 130  FORMAT(12X,'IDEAL ALVEOLAR PO2                      =',F10.2,/,
     112X'IDEAL ALVEOLAR PCO2                     =',F10.2,/,
     112X'IDEAL ALVEOLAR-ARTERIAL PO2 DIFFERENCE  =',F10.2,/,
     112X'IDEAL O2 CONTENT                        =',F10.2,/,
     112X'PHYSIOLOGIC DEAD SPACE PCT              =',F10.2,/,
     112X'VENOUS ADMIXTURE PCT                    =',F10.2,/,
     112X'NUMBER OF TIMES SATURA CALLED           =',I10,/,
     112X'IDEAL VA/Q                              =',F10.2)
 140  CONTINUE
      WRITE(3,150) ARTPM,CONPM,GRADMP
 150  FORMAT(/,
     1'  PREDICTED - MEASURED ARTERIAL PO2                 ='F10.2,/,
     2'  PREDICTED - MEASURED ARTERIAL CONTENT             ='F10.2,/,
     3'  MEASURED - PREDICTED ALVEOLAR-ARTERIAL GRADIENT   ='F10.2//)
      GO TO 220
 160  CONTINUE
      IF(ARTPM.LE.1.0) GO TO 220
      AA=0.0
      BB=0.0
      EE=0.0
      FFF=0.0
      DO 180 I=1,NVAQS
      AA=AA+V(I)*PO22(I)
      BB=BB+V(I)*PCO22(I)
      EE=EE+V(I)*PN22(I)
      FFF=FFF+Q(I)*PN22(I)
 180  CONTINUE
      ALVPO2=AA/VT
      ALVPCO=BB/VT
      ALVPN2=EE/VT
      ARTPN2=FFF/QT
      O2IN=FVO2
      CO2OUT=FVCO2
      OVERAL=CO2OUT/O2IN
      RMEAS=GVCO2/GVO2
      WRITE(3,190) ALVPO2,ALVPCO,O2IN,CO2OUT,OVERAL,RMEAS
 190  FORMAT(12X,'MIXED EXPIRED  PO2                      =',F10.2,/,
     112X,'MIXED EXPIRED  PCO2                     =',F10.2,/,
     112X,'OXYGEN UPTAKE                           =',F10.2,/,
     112X,'CARBON DIOXIDE OUTPUT                   =',F10.2,/,
     112X,'PREDICTED R                             =',F10.2,/,
     112X,'MEASURED R                              =',F10.2,/)
      CALL FNDTEN(ARTPO2,ARTPCO,ARTO2C,ARTCO2)
      O2DIF=ALVPO2-ARTPO2
      CO2DIF=ARTPCO-ALVPCO
      DIFN2=ARTPN2-ALVPN2
      WRITE(3,200) ARTPO2,ARTPCO,ARTO2C,ARTCO2,O2DIF,CO2DIF,DIFN2
 200  FORMAT(12X,'ARTERIAL PO2                            =',F10.2,/,
     112X,'ARTERIAL PCO2                           =',F10.2,//,
     112X,'ARTERIAL O2 CONTENT                     =',F10.2,/,
     112X,'ARTERIAL CO2 CONTENT                    =',F10.2,/,
     112X,'MIXED ALVEOLAR-ARTERIAL PO2 DIFFERENCE  =',F10.2,/,
     112X,'MIXED ALVEOLAR-ARTERIAL PCO2 DIFFERENCE =',F10.2,/,
     112X,'MIXED ALVEOLAR-ARTERIAL PN2 DIFFERENCE  =',F10.2)
      NT=RNT
      WRITE (3,210) DDLO2,DDLCO2,NT
 210  FORMAT(/12X,'DLO2  by Bohr Integration               =',F10.2,/,
     112X,'DLCO2 set to 5*DLO2                     =',F10.2,/,
     212X,'NUMBER OF STEPS USED                    =',I10,///)
      IF (IWARN2.EQ.0) GOTO 220
      WRITE(3,215)
      WRITE(*,215)
 215  FORMAT(' Possible truncation error: try smaller step size')     
 220  CONTINUE
      RETURN
      END
      SUBROUTINE VQSOLN
      DIMENSION X(4),Y(4),G(4),U(4),F(4)
      COMMON/INERT/NVAQS,VT,QT,NGASES,FACT,Z,VQLO,VQHI
      COMMON/OXY1/HB,HCRIT,TEMP,APH,BPH,APCO2,BPCO2,KOUNT,DP50,PIO2,SO2
      COMMON/OXY2/PB,FIO2,PICO2,FICO2,VS,QS,SKEW,GVO2,GVCO2,TOL,
     + PVO2,PVCO2,FMVO2,FMVCO2,PVN2,ALPHA,SHUNT,QR,GVAQ,FVQ,PAO2,
     + PACO2,O2CON,CCO2,PO2,PCO2,FVO2,FVCO2,RZ,RM,ARTO2C,ARTCO2,AMO2C
C      COMMON/VQ/V(500),Q(500),QQ(500),VAQ(500)
      COMMON/BOHR/DM,VC,BETA,RNT,DDLO2,DDLCO2,PMAO2,PMACO2,PO2B,PCO2B,
     + IBOHR,CAIII,IPRN,ARTPM,IWARN,IWARN2
C      COMMON/O2ARAY/OO2CON(500),OCCO2(500),FVQQ(500),PN22(500),
C     +PCO22(500),PO22(500),RZZ(500),PBO2(500),PBCO2(500)
      TOL1=0.001
      Y(1)=PVCO2*6.0/(6.0 + GVAQ)
      Y(2)=Y(1) + 5.0
      Y(3)=Y(2)
      IF(GVAQ.LE.0.55) GO TO 20
      IF(GVAQ.GE.10.0)GO TO 10
      X(1) = PIO2-30.0
      X(2) = PIO2-60.0
      X(3) = PIO2-30.0
      GO TO 30
  10  CONTINUE
      X(1)=PIO2
      X(2)=0.95*PIO2+0.05*PVO2
      X(3) = X(1)
      GO TO 30
  20  CONTINUE
      X(1) = PVO2 + 0.1
      X(2)=X(1)+10.0
      X(3)=X(1)
  30  CONTINUE
      ITER=0
      NNN=3
  40  DO 90 N=1,NNN
      CALL BOHRI(X(N),Y(N),O2CON,CCO2)
      IF(PVN2.EQ.0.0) GO TO 50 
C     N2 EXCHANGE INCORPORATED
      RZ=(FMVCO2-CCO2)/(O2CON-FMVO2)
      PAO2=X(N)
      PACO2=Y(N)
      FAO2=PAO2*FIO2/PIO2
      FACO2=PACO2*FIO2/PIO2
      FVN2=PVN2*FIO2/PIO2
      C1=1.0-FAO2-FACO2
      C2=C1-FVN2
      C3=1.0-FIO2-FICO2
      B1=GVAQ*C1/C3
      B2=8.63*ALPHA*C2/C3
      O2CON1=FMVO2 + (PIO2*(B1+B2) - PAO2*GVAQ)/8.63
      CCO21=FMVCO2 - (PACO2*GVAQ - PICO2*(B1+B2))/8.63
      GO TO 60 
  50  CONTINUE
C     N2 EXCHANGE IGNORED
      ABAB=Y(N)*(1.0-FIO2) - FICO2*(PIO2/FIO2 - X(N))
      AAAA=ABAB*GVAQ/(8.63*(1.0-FIO2-FICO2))
      BBAA=PIO2-X(N)*(1.0-FICO2) - FIO2*Y(N)
      AABB=Y(N)*(1.0-FIO2) - PICO2 + FICO2*X(N)
      RZ=AABB/BBAA
      O2CON1 = FMVO2 + AAAA/RZ
      CCO21 = FMVCO2-AAAA
  60  CONTINUE
      F(N) = O2CON-O2CON1
      G(N) = CCO2-CCO21
      IF(ABS(F(N))-TOL1) 70,70,90
  70  IF(ABS(G(N))-TOL1) 80,80,90
  80  CONTINUE
      PAO2=X(N)
      PACO2=Y(N)
      GO TO 210
  90  CONTINUE
      DO 100 N=1,3
 100  U(N)=1.0
      CALL DETERM(U,F,G,DET1)
      DO 110 N=1,3
 110  U(N)=X(N)
      NFLAG=0
 120  CALL DETERM(U,F,G,DET2)
      IF(NFLAG-1) 130,140,140
 130  IF(DET1.NE.0.0) X(4) = DET2/DET1
      IF(DET1.EQ.0.0) X(4)=PAO2 + 1.0
      GO TO 150
 140  IF(DET1.NE.0.0) Y(4) = DET2/DET1
      IF(DET1.EQ.0.0) Y(4)=PACO2+1.0
 150  IF(NFLAG-1) 160,180,180
 160  DO 170 N=1,3
 170  U(N)=Y(N)
      NFLAG=1
      GO TO 120
 180  DO 190 N=1,2
      J=4-N
      X(J)=X(J-1)
      Y(J)=Y(J-1)
      F(J)=F(J-1)
      G(J)=G(J-1)
 190  CONTINUE
      X(1)=X(4)
      Y(1)=Y(4)
      NNN=1
      ITER=ITER+1
      IF(ITER-20) 200,210,210
 200  GO TO 40 
 210  CONTINUE
      IF(PICO2.GT.0.0) GO TO 220
      FVQ=8.63*(FMVCO2-CCO2)/PACO2
      GO TO 230
 220  CONTINUE
      D1=(O2CON-FMVO2)/PIO2 + (FMVCO2-CCO2)/PICO2
      D2=PACO2/PICO2-PAO2/PIO2
      FVQ=8.63*D1/D2
 230  CONTINUE
      PO2=PAO2
      PCO2=PACO2
      RETURN
      END
      SUBROUTINE FTEN(X,Y,OXO2,COCON,PO2,PCO2)
C      DOUBLE PRECISION U,F,G,DET1,DET2
      DIMENSION X(4),Y(4),F(4),G(4),U(4)
      COMMON/OXY1/HB,HCRIT,TEMP,APH,BPH,APCO2,BPCO2,KOUNT,DP50,PIO2,SO2
      DO 10 KK=1,4
      F(KK)=0.
      G(KK)=0.
      U(KK)=0.
  10  CONTINUE
      ITER=0
      TOL=.001
      NNN=3
  20  DO 50 N=1,NNN
      PH1=PH(Y(N),0.0)
      Y1=.003*HB*(1.-SATURA(X(N),Y(N),PH1)/100.)
      PH2=PH(Y(N),Y1)
      SATRN=SATURA(X(N),Y(N),PH2)
      FNN=.0139*HB*SATRN+SO2*X(N)-OXO2
      GNN=CO2CON(Y(N),PH2,SATRN)-COCON
      F(N)=FNN
      G(N)=GNN
      IF(ABS(FNN)-TOL)30,30,50
  30  IF(ABS(GNN)-TOL)40,40,50
  40  PO2=X(N)
      PCO2=Y(N)
      GO TO 170
  50  CONTINUE
      DO 60 N=1,3
      U(N)=1.
  60  CONTINUE
      CALL DETER(U,F,G,DET1)
      DO 70 N=1,3
      U(N)=X(N)
  70  CONTINUE
      NFLAG=0
      PNO2=X(1)
      PNCO2=Y(1)
  80  CALL DETER(U,F,G,DET2)
      IF(NFLAG-1)90,100,100
  90  IF(DET1.EQ.0.) X(4)=PNO2*1.05
      IF(DET1.NE.0.) X(4)=DET2/DET1
      GO TO 110
  100 IF(DET1.EQ.0.) Y(4)=PNCO2*.95
      IF(DET1.NE.0.) Y(4)=DET2/DET1
  110 IF(NFLAG-1)120,140,140
  120 DO 130 N=1,3
      U(N)=Y(N)
  130 CONTINUE
      NFLAG=1
      GO TO 80
  140 DO 150 N=1,2
      J=4-N
      X(J)=X(J-1)
      Y(J)=Y(J-1)
      F(J)=F(J-1)
      G(J)=G(J-1)
  150 CONTINUE
      X(1)=X(4)
      Y(1)=Y(4)
      NNN=1
      ITER=ITER+1
      IF(ITER-30)160,170,170
  160 GO TO 20
  170 CONTINUE
      X(1)=PO2
      X(2)=PO2
      X(3)=PO2+5.
      Y(1)=PCO2
      Y(2)=PCO2-5.
      IF(Y(2).LE.1.0) Y(2)=1.0
      Y(3)=PCO2
      RETURN
      END
      SUBROUTINE BOHRI(PAAO2,PAACO2,O2CONE,CCO2E)
      DIMENSION X(4),Y(4),GRADO2(5),GRADCO(5)
      COMMON/INERT/NVAQS,VT,QT,NGASES,FACT,Z,VQLO,VQHI
      COMMON/OXY1/HB,HCRIT,TEMP,APH,BPH,APCO2,BPCO2,KOUNT,DP50,PIO2,SO2
      COMMON/OXY2/PB,FIO2,PICO2,FICO2,VS,QS,SKEW,GVO2,GVCO2,TOL,
     + PVO2,PVCO2,FMVO2,FMVCO2,PVN2,ALPHA,SHUNT,QR,GVAQ,FVQ,PAO2,
     + PACO2,O2CON,CCO2,PO2,PCO2,FVO2,FVCO2,RZ,RM,ARTO2C,ARTCO2,AMO2C
      COMMON/O2ARAY/OO2CON(500),OCCO2(500),FVQQ(500),PN22(500),
     +PCO22(500),PO22(500),RZZ(500),PBO2(500),PBCO2(500)
      COMMON/BOHR/DM,VC,BETA,RNT,DDLO2,DDLCO2,PMAO2,PMACO2,PO2B,PCO2B,
     + IBOHR,CAIII,IPRN,ARTPM,IWARN,IWARN2
      IWARN=0
      PAO2=PAAO2
      PACO2=PAACO2
      IF (DM.GT.9000.0.OR.IBOHR.EQ.1) GO TO 30
      DO 10 I=1,5
      GRADCO(I)=0.0
      GRADO2(I)=0.0
10    CONTINUE
      O2CI=FMVO2
      CO2CI=FMVCO2
      X(1)=PVO2
      X(2)=PVO2
      X(3)=PVO2+5.
      Y(1)=PVCO2
      Y(2)=PVCO2-5.
      Y(3)=PVCO2
      X(4)=0.
      Y(4)=0.
      PASTPO=0.
      PASTPC=0.
      NT=RNT
      DDLO2=DM
      DDLCO2=5.0*DM
      DO 20 I=1,NT
      CALL CALC(X,Y,O2CI,CO2CI,FO21,FCO21)
      IF((FO21.EQ.9000.0).OR.(FCO21.EQ.9000.0)) GOTO 30 
      CALL CALC(X,Y,O2CI+FO21/2.0,CO2CI+FCO21/2.0,FO22,FCO22)
      IF((FO22.EQ.9000.0).OR.(FCO22.EQ.9000.0)) GOTO 30 
      CALL CALC(X,Y,O2CI+FO22/2.0,CO2CI+FCO22/2.0,FO23,FCO23)
      IF((FO23.EQ.9000.0).OR.(FCO23.EQ.9000.0)) GOTO 30
      CALL CALC(X,Y,O2CI+FO23,CO2CI+FCO23,FO24,FCO24)
      IF((FO24.EQ.9000.0).OR.(FCO24.EQ.9000.0)) GOTO 30
      O2CI=O2CI+(FO21+FO22*2.0+FO23*2.0+FO24)/6.0
      CO2CI=CO2CI+(FCO21+FCO22*2.0+FCO23*2.0+FCO24)/6.0
      CALL FTEN(X,Y,O2CI,CO2CI,PO2I,PCO2I)
      PASTPO=PO2I
      PASTPC=PCO2I
  20  CONTINUE
      IF (DM.LT.9000.) GO TO 40
C
C     COME HERE IF DM IS ESSENTIALLY INFINITE ....
C
  30  PO2I=PAO2
      PCO2I=PACO2
      IWARN=1
      CALL BLOOD(PO2I,PCO2I,O2CI,CO2CI)
  40  CONTINUE
      O2CONE=O2CI
      CCO2E=CO2CI
      PO2B=PO2I
      PCO2B=PCO2I
      RETURN
      END
      SUBROUTINE CALC(X,Y,O2CI,CO2CI,DO2CI,DCO2CI)
C
C     THIS SUBROUTINE CALCULATES DO2,DCO2 FROM OTHER INPUTS
C
      DIMENSION X(4),Y(4)
      COMMON/INERT/NVAQS,VT,QT,NGASES,FACT,Z,VQLO,VQHI
      COMMON/OXY1/HB,HCRIT,TEMP,APH,BPH,APCO2,BPCO2,KOUNT,DP50,PIO2,SO2
      COMMON/OXY2/PB,FIO2,PICO2,FICO2,VS,QS,SKEW,GVO2,GVCO2,TOL,
     + PVO2,PVCO2,FMVO2,FMVCO2,PVN2,ALPHA,SHUNT,QR,GVAQ,FVQ,PAO2,
     + PACO2,O2CON,CCO2,PO2,PCO2,FVO2,FVCO2,RZ,RM,ARTO2C,ARTCO2,AMO2C
      COMMON/O2ARAY/OO2CON(500),OCCO2(500),FVQQ(500),PN22(500),
     +PCO22(500),PO22(500),RZZ(500),PBO2(500),PBCO2(500)
      COMMON/BOHR/DM,VC,BETA,RNT,DDLO2,DDLCO2,PMAO2,PMACO2,PO2B,PCO2B,
     + IBOHR,CAIII,IPRN,ARTPM,IWARN,IWARN2
      O2C=(1.39*HB) + (SO2*PIO2)
      IF ((CO2CI.LT.0.0).OR.(O2CI.GT.O2C)) GOTO 10
      CALL FTEN(X,Y,O2CI,CO2CI,PO2I,PCO2I)
      IF ((PO2I.LE.PAO2+2.0).AND.(PCO2I.GE.PACO2-1.0)) GOTO 20
  10  IF (PO2I.GT.PAO2+2.0) DO2CI=9000.0
      IF (PCO2I.LT.PACO2-1.0) DCO2CI=9000.0
      IF (CO2CI.LT.0.0) DCO2CI=9000.0
      IF (O2CI.GT.O2C) DO2CI=9000.0 
      GOTO 30
  20  CONTINUE 
      DO2CI=(PAO2-PO2I)*DDLO2/(RNT*(QT-QS)*10.)
      DCO2CI=(PACO2-PCO2I)*DDLCO2/(RNT*(QT-QS)*10.)
  30  IF(IPRN.LE.0) GO TO 40 
      WRITE(*,35)O2CI,CO2CI,PO2I,PCO2I
  35  FORMAT(' IN CALC, O2CI,CO2CI,PO2I & PCO2I ARE:',4F10.3)
      WRITE(*,37)PAO2,PO2I,DM,DDLO2
  37  FORMAT(' IN CALC, PAO2,PO2I,DM & DDLO2 ARE:',4F10.3)
  40  CONTINUE
      RETURN
      END
      SUBROUTINE DETER(U,F,G,DET)
C
C     THIS SUBROUTINE IS USED BY BOTH THE MATCHING PROCEDURES.
C
      DIMENSION U(4),F(4),G(4),W(4)
C      DOUBLE PRECISION U,F,G,W,D,DET
      DO 10 KK=1,4
  10  W(KK)=0.0
      I=1
      J=2
      K=3
  20  W(I)=U(I)*(F(J)*G(K)-F(K)*G(J))
      IF(I-3)30,60,60
  30  IF(I-1)40,40,50
  40  I=2
      J=3
      K=1
      GO TO 20
  50  I=3
      J=1
      K=2
      GO TO 20
  60  D=0.
      DO 70 I=1,3
      D=D+W(I)
  70  CONTINUE
      DET=D
      RETURN
      END